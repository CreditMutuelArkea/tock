<!--
  ~ Copyright (C) 2017/2021 e-voyageurs technologies
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<nb-card class="mt-3 mb-2">
  <nb-card-header>All Entity Types</nb-card-header>
  <nb-card-body>
    <div class="entities">
      <div
        *ngFor="let e of state.entityTypesSortedByName() | async"
        class="entity"
        [class.entity-dictionary]="e.dictionary"
        [class.entity-selected]="e === selectedEntityType"
        [class.entity-dictionary-selected]="e.dictionary && e === selectedEntityType"
        [class.pointer]="e.namespace() === state.currentApplication.namespace"
        (click)="selectEntityType(e)"
      >
        <nb-icon
          *ngIf="e === selectedEntityType"
          class="entity-selected-mark"
          icon="checkmark-outline"
        ></nb-icon>
        {{ e.nameWithoutNamespace(state.currentApplication.namespace) }}
        <div
          *ngIf="
            e.namespace() === state.currentApplication.namespace ||
            (e.namespace() === state.currentApplication.namespace && e.dictionary) ||
            (e.namespace() === state.currentApplication.namespace && !e.dictionary)
          "
        >
          <button
            *ngIf="e.namespace() === state.currentApplication.namespace && !e.dictionary"
            nbButton
            ghost
            shape="round"
            size="small"
            status="primary"
            nbTooltip="Add predefined values"
          >
            <nb-icon icon="plus-circle-outline"></nb-icon>
          </button>
          <button
            *ngIf="e.namespace() === state.currentApplication.namespace && e.dictionary"
            class="entity-update"
            nbButton
            ghost
            shape="round"
            size="small"
            nbTooltip="Update predefined values"
          >
            <nb-icon icon="checkmark-circle-outline"></nb-icon>
          </button>
          <button
            *ngIf="e.namespace() === state.currentApplication.namespace"
            nbButton
            ghost
            shape="round"
            size="small"
            status="danger"
            nbTooltip="Delete"
            (click)="$event.stopPropagation(); deleteEntityType(e)"
          >
            <nb-icon icon="trash-2-outline"></nb-icon>
          </button>
        </div>
      </div>
    </div>
  </nb-card-body>
</nb-card>
<nb-card
  *ngIf="!!selectedEntityType"
  class="mb-2"
>
  <nb-card-header>Configuration for {{ selectedEntityType.name }}</nb-card-header>
  <nb-card-body>
    <nb-checkbox
      [(ngModel)]="selectedEntityType.obfuscated"
      (checkedChange)="updateEntityType()"
      nbTooltip="If selected all values are obfuscated in Tock Studio"
    >
      Obfuscated
    </nb-checkbox>
  </nb-card-body>
</nb-card>
<nb-card
  *ngIf="!!selectedDictionary"
  class="mb-2"
>
  <nb-card-header>Predefined values for {{ selectedEntityType.name }}</nb-card-header>
  <nb-card-body>
    <div>
      <div class="d-flex align-items-center gap-1 mb-2">
        <nb-checkbox
          [(ngModel)]="selectedDictionary.onlyValues"
          (change)="updateDictionary()"
          nbTooltip="If selected, no model is used: only exact values are recognized/evaluated"
        >
          No Model
        </nb-checkbox>
        <input
          *ngIf="!selectedDictionary.onlyValues"
          nbInput
          type="number"
          placeholder="Model Limit"
          min="0"
          max="1"
          step="0.1"
          nbTooltip="Number between 0 and 1 - only probability above this value are evaluated"
          [(ngModel)]="selectedDictionary.minDistance"
          (change)="updateDictionary()"
        />
      </div>
      <div class="mb-2">
        <nb-checkbox
          nbTooltip="If selected, all the values that contains the searched text are returned"
          [(ngModel)]="selectedDictionary.textSearch"
          (change)="updateDictionary()"
        >
          Full Text
        </nb-checkbox>
      </div>
      <div class="d-flex flex-wrap gap-1 mb-4">
        <button
          nbButton
          nbTooltip="Download Dictionary"
          size="small"
          outline
          status="primary"
          (click)="downloadDictionary()"
        >
          <nb-icon icon="download-outline"></nb-icon>
          Download Dictionary
        </button>
        <button
          nbButton
          nbTooltip="Download Dictionary"
          size="small"
          outline
          status="primary"
          (click)="file.hidden = false; $event.srcElement.setAttribute('style', 'display:none')"
        >
          <nb-icon icon="upload-outline"></nb-icon>
          Upload Dictionary
        </button>
        <input
          #file
          [hidden]="true"
          id="file"
          type="file"
          ng2FileSelect
          [uploader]="uploader"
        />
      </div>
      <div class="d-flex">
        <input
          nbInput
          placeholder="Add new predefined value"
          #pv
          (keyup.enter)="createPredefinedValue(pv.value); pv.value = ''"
        />
        <button
          nbButton
          status="primary"
          (click)="createPredefinedValue(pv.value)"
        >
          <nb-icon icon="plus-outline"></nb-icon>
        </button>
      </div>
    </div>

    <table
      class="mt-2 w-100"
      *ngIf="selectedDictionary.values.length !== 0"
    >
      <thead>
        <th [width]="'20%'">Predefined Value</th>
        <th [width]="'50%'">Allowed labels</th>
        <th [width]="'30%'">Actions</th>
      </thead>
      <tbody>
        <tr *ngFor="let predefinedValue of selectedDictionary.values">
          <td>
            <input
              nbInput
              fieldSize="small"
              #pv
              [(value)]="predefinedValue.value"
              (blur)="updatePredefinedValueName(predefinedValue, pv)"
            />
          </td>
          <td>
            <nb-tag-list>
              <nb-tag
                *ngFor="let label of predefinedValue.labels.get(state.currentLocale)"
                removable
                [text]="label"
                (click)="deleteLabel(predefinedValue, label)"
              ></nb-tag>
            </nb-tag-list>
          </td>
          <td
            class="d-flex gap-1"
            style="white-space: nowrap"
          >
            <div class="d-flex">
              <input
                nbInput
                fieldSize="small"
                placeholder="Add label"
                #l
                (keyup.enter)="createLabel(predefinedValue, l.value)"
              />
              <button
                nbButton
                status="primary"
                size="small"
                nbTooltip="Add Label"
                (click)="createLabel(predefinedValue, l.value)"
              >
                <nb-icon icon="plus-outline"></nb-icon>
              </button>
            </div>
            <button
              nbButton
              ghost
              shape="round"
              size="small"
              status="danger"
              nbTooltip="Delete predefined value"
              (click)="deletePredefinedValue(predefinedValue.value)"
            >
              <nb-icon icon="trash-2-outline"></nb-icon>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </nb-card-body>
</nb-card>
<nb-card>
  <nb-card-header>Entity roles</nb-card-header>
  <nb-card-body>
    <tock-entity-details
      *ngFor="let e of state.entities | async"
      class="d-block mb-2"
      [entity]="e"
    ></tock-entity-details>
  </nb-card-body>
</nb-card>
