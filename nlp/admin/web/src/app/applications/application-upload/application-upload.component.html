<!--
  ~ Copyright (C) 2017/2021 e-voyageurs technologies
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<nb-card
  *ngIf="configuration"
  [nbSpinner]="uploading"
  class="mt-3"
>
  <nb-card-header>Upload a Dump</nb-card-header>
  <nb-card-body>
    <div *ngIf="!report">
      <p>
        <nb-radio-group
          [(ngModel)]="type"
          name="upload-type-group"
        >
          <nb-radio
            *ngIf="state.hasRole(UserRole.technicalAdmin)"
            value="application"
          >
            Application Dump
          </nb-radio>
          <nb-radio value="sentences"> Sentences Dump </nb-radio>
        </nb-radio-group>
      </p>
      <ul>
        <li *ngIf="state.hasRole(UserRole.technicalAdmin)">
          The "Application Dump" format is an internal format, useful to copy application data across environments.
        </li>
        <li>The "Sentences Dump" format is an agnostic format, used to share data with other systems.</li>
      </ul>
      <div
        *ngIf="!applicationName"
        class="d-flex flex-column mb-3"
      >
        <label
          for="applicationName"
          class="font-weight-bold text-mitigated"
        >
          Application name
        </label>
        <input
          nbInput
          id="applicationName"
          name="applicationName"
          placeholder="Target Application Name"
          [(ngModel)]="configuration.newApplicationName"
        />
        <small class="text-mitigated">(If empty, application name in dump will be used)</small>
      </div>

      <div class="d-flex flex-column">
        <label
          for="file"
          class="font-weight-bold text-mitigated"
        >
          Please select a dump file
        </label>
        <input
          id="file"
          type="file"
          ng2FileSelect
          [uploader]="uploader"
        />
      </div>
    </div>
    <div *ngIf="report">
      <div *ngIf="!report.success">
        <h4>Error occurs during import</h4>
        <ul>
          <li *ngFor="let e of report.errorMessages">
            {{ e }}
          </li>
        </ul>
      </div>
      <div *ngIf="report.success">
        <p
          *ngIf="!report.modified"
          class="h5"
        >
          No new data found, so no data imported.
        </p>
        <div *ngIf="report.modified">
          <p class="h5">Successful Import Report:</p>
          <nb-list class="list">
            <nb-list-item *ngIf="report.applicationsImported.length !== 0">
              <p class="h6">Applications imported</p>
              <div
                *ngFor="let app of report.applicationsImported"
                class="d-flex flex-wrap gap-1 mb-1"
              >
                <nb-icon icon="keypad-outline"></nb-icon>
                <span>{{ app }}</span>
              </div>
            </nb-list-item>
            <nb-list-item *ngIf="report.entitiesImported.length !== 0">
              <p class="h6">Entities imported</p>
              <div
                *ngFor="let entity of report.entitiesImported"
                class="d-flex flex-wrap gap-1 mb-1"
              >
                <nb-icon icon="droplet-outline"></nb-icon>
                <span>{{ entity }}</span>
              </div>
            </nb-list-item>
            <nb-list-item *ngIf="report.intentsImported.length !== 0">
              <p class="h6">Intents imported</p>
              <div
                *ngFor="let intent of report.intentsImported"
                class="d-flex flex-wrap gap-1 mb-1"
              >
                <nb-icon icon="corner-left-up-outline"></nb-icon>
                <span>{{ intent }}</span>
              </div>
            </nb-list-item>
            <nb-list-item *ngIf="report.sentencesImported !== 0">
              <p class="h6">Number of sentences imported</p>
              <div class="d-flex gap-1">
                <nb-icon icon="list-outline"></nb-icon>
                <span>{{ report.sentencesImported }}</span>
              </div>
            </nb-list-item>
            <nb-list-item *ngIf="report.faqsImported !== 0">
              <p class="h6">Number of FAQs imported</p>
              <div class="d-flex gap-1">
                <nb-icon icon="list-outline"></nb-icon>
                <span>{{ report.faqsImported }}</span>
              </div>
            </nb-list-item>
          </nb-list>
          <div *ngIf="report.errorMessages.length !== 0">
            <h5>Errors:</h5>
            <ul>
              <li *ngFor="let e of report.errorMessages">
                {{ e }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nb-card-body>
  <nb-card-footer class="card-footer-actions">
    <button
      *ngIf="!report"
      nbButton
      size="small"
      ghost
      (click)="cancel()"
    >
      Cancel
    </button>
    <button
      *ngIf="report"
      nbButton
      size="small"
      outline
      status="primary"
      (click)="close()"
    >
      Hide dump report
    </button>
    <button
      *ngIf="!report"
      nbButton
      size="small"
      status="primary"
      [disabled]="!uploader.getNotUploadedItems().length"
      (click)="upload()"
    >
      Upload
    </button>
  </nb-card-footer>
</nb-card>
