<div class="grid-columns-header">
  <div class="d-flex gap-1 align-items-center">
    <nb-checkbox
      class="lineHeight-0"
      [checked]="selection?.selected?.length === sentences?.length"
      [indeterminate]="selection?.selected?.length && selection.selected.length < sentences?.length"
      (checkedChange)="handleToggleSelectAll($event)"
    ></nb-checkbox>
    <div
      *ngIf="selection.selected.length"
      class="d-flex gap-1"
      data-testid="batch-action"
    >
      <button
        nbButton
        nbTooltip="Validate all selected sentences"
        status="success"
        ghost
        shape="round"
        (click)="handleBatchAction(Action.VALIDATE)"
        data-testid="batch-action-validate"
      >
        <nb-icon icon="checkmark-circle-2"></nb-icon>
      </button>
      <button
        *ngIf="!isFilteredUnknown"
        nbButton
        nbTooltip="Set all selected sentences as unknown"
        status="warning"
        ghost
        shape="round"
        (click)="handleBatchAction(Action.UNKNOWN)"
        data-testid="batch-action-unknown"
      >
        <nb-icon icon="question-mark-circle-outline"></nb-icon>
      </button>
      <button
        *ngIf="sentenceTrainingMode !== SentenceTrainingMode.RAGEXCLUDED"
        nbButton
        nbTooltip="Set all selected sentences as ragexcluded"
        status="warning"
        ghost
        shape="round"
        (click)="handleBatchAction(Action.RAGEXCLUDED)"
        data-testid="batch-action-ragexcluded"
      >
        <nb-icon icon="alert-triangle-outline"></nb-icon>
      </button>
      <button
        nbButton
        nbTooltip="Delete all selected sentences"
        status="danger"
        ghost
        shape="round"
        (click)="handleBatchAction(Action.DELETE)"
        data-testid="batch-action-delete"
      >
        <nb-icon icon="trash-2-outline"></nb-icon>
      </button>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-1">
    <span
      class="pointer"
      (click)="toggleSort()"
      data-testid="sort"
    >
      Sort by creation date
      <nb-icon
        *ngIf="!isSorted"
        icon="chevron-down-outline"
        class="valign-middle"
      ></nb-icon>
      <nb-icon
        *ngIf="isSorted"
        icon="chevron-up-outline"
        class="valign-middle"
      ></nb-icon>
    </span>

    <tock-pagination
      [pagination]="pagination"
      (onPaginationChange)="paginationChange($event)"
    ></tock-pagination>
  </div>
</div>

<nb-card
  *ngFor="let sentence of sentences"
  [ngClass]="{ 'my-2': true, selected: sentence._selected }"
  [id]="getSentenceId(sentence)"
  data-testid="list"
>
  <nb-card-body class="grid-columns p-3">
    <nb-checkbox
      [checked]="isSentenceSelected(sentence)"
      (checkedChange)="toggle(sentence)"
      class="mt-1"
    ></nb-checkbox>

    <div data-testid="text">
      <tock-sentence-training-sentence [sentence]="sentence"></tock-sentence-training-sentence>

      <nb-card
        class="mx-3 mt-2 mb-0"
        accent="info"
        *ngIf="sentence.forReview && sentence.reviewComment"
      >
        <nb-card-body class="text-muted review">
          <strong class="d-block">Review comment :</strong>
          {{ sentence.reviewComment }}
        </nb-card-body>
      </nb-card>
    </div>

    <div class="tools-panel">
      <small class="d-block text-muted unselectable">
        <button
          nbButton
          ghost
          size="tiny"
          class="mr-2 lineFirstSmallButtonRetract"
          nbTooltip="Copy sentence"
          (click)="copySentence(sentence)"
        >
          <nb-icon icon="copy-outline"></nb-icon>
        </button>

        <time>{{ sentence.creationDate | date: 'yy/MM/dd HH:mm:ss' }}</time>

        <span
          class="text-uppercase ml-2 px-1"
          [style.color]="sentence.statusColor()"
          nbTooltip="Sentence status"
        >
          {{ sentence.statusDisplayed() }}
        </span>

        <span nbTooltip="Sentence configuration">
          {{ sentence.configuration }}
        </span>
      </small>

      <nb-form-field
        class="mb-1"
        nbTooltip="Intent association"
      >
        <input
          nbInput
          fullWidth
          type="text"
          placeholder="{{ selectIntent(sentence, 'placeholder') }}"
          (focus)="onFocus($event)"
          (blur)="onBlur($event)"
          (keyup.escape)="onBlur($event)"
          (keyup)="filterIntentsList($event)"
          autocomplete="off"
          [nbAutocomplete]="intentsAutocomplete"
          class="intent-input"
        />
        <small
          nbSuffix
          nbTooltip="Detection probability"
          class="pr-2"
        >
          {{ selectIntent(sentence, 'probability') }}%
        </small>
      </nb-form-field>
      <nb-autocomplete
        size="tiny"
        #intentsAutocomplete
        (selectedChange)="addIntentToSentence($event, sentence)"
      >
        <nb-option-group
          *ngFor="let group of filteredIntentGroups | async"
          [title]="group.category"
        >
          <nb-option
            *ngFor="let intent of group.intents"
            [value]="intent._id"
          >
            {{ intent.label || intent.name }}
          </nb-option>
        </nb-option-group>
      </nb-autocomplete>

      <div class="d-flex flex-wrap justify-content-between">
        <button
          nbButton
          nbTooltip="Validate"
          status="success"
          ghost
          shape="round"
          size="large"
          class="lineFirstLargeButtonRetract"
          (click)="handleAction(Action.VALIDATE, sentence)"
          data-testid="validate"
        >
          <nb-icon icon="checkmark-circle-2"></nb-icon>
        </button>

        <button
          nbButton
          nbTooltip="Ask for review"
          status="info"
          ghost
          shape="round"
          size="large"
          (click)="askForReview(sentence)"
        >
          <nb-icon icon="search-outline"></nb-icon>
        </button>

        <button
          *ngIf="!isFilteredUnknown"
          nbButton
          nbTooltip="Set as unknown"
          status="warning"
          ghost
          shape="round"
          size="large"
          (click)="handleAction(Action.UNKNOWN, sentence)"
          data-testid="unknown"
        >
          <nb-icon icon="question-mark-circle-outline"></nb-icon>
        </button>

        <button
          *ngIf="sentenceTrainingMode !== SentenceTrainingMode.RAGEXCLUDED"
          nbButton
          nbTooltip="Exclude from Rag handling"
          status="warning"
          ghost
          shape="round"
          size="large"
          (click)="handleAction(Action.RAGEXCLUDED, sentence)"
          data-testid="ragexcluded"
        >
          <nb-icon icon="alert-triangle-outline"></nb-icon>
        </button>

        <button
          nbButton
          nbTooltip="Delete"
          status="danger"
          ghost
          shape="round"
          size="large"
          (click)="handleAction(Action.DELETE, sentence)"
          data-testid="delete"
        >
          <nb-icon icon="trash-2-outline"></nb-icon>
        </button>

        <nb-select
          [(ngModel)]="sentence.language"
          placeholder="Sentence language"
          nbTooltip="Set sentence language"
          class="ml-2 mt-1 flex-grow-1"
        >
          <nb-option
            *ngFor="let l of state.currentApplication.supportedLocales"
            [value]="l"
          >
            {{ state.localeName(l) }}
          </nb-option>
        </nb-select>
      </div>

      <div class="d-flex flex-wrap justify-content-between">
        <div>
          <button
            nbButton
            nbTooltip="Create new Intent"
            ghost
            shape="round"
            class="lineFirstButtonRetract"
          >
            <nb-icon icon="plus-circle-outline"></nb-icon>
          </button>

          <button
            *ngIf="state.hasRole(UserRole.botUser)"
            nbButton
            nbTooltip="Create new FAQ based on this sentence"
            ghost
            shape="round"
            (click)="redirectToFaqManagement(sentence)"
            data-testid="redirectToFaqManagement"
          >
            <nb-icon icon="message-square-outline"></nb-icon>
          </button>
        </div>

        <button
          nbButton
          nbTooltip="Show conversation"
          ghost
          shape="round"
          status="info"
          (click)="showDetails(sentence)"
          data-testid="details"
        >
          <nb-icon icon="message-circle-outline"></nb-icon>
        </button>
      </div>
    </div>
  </nb-card-body>
</nb-card>
