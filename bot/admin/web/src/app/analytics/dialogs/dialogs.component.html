<!--
  ~ Copyright (C) 2017/2021 e-voyageurs technologies
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<div
  class="mt-3"
  [nbSpinner]="loading"
>
  <nb-card class="mb-2">
    <nb-card-body class="d-flex flex-column gap-1">
      <div class="grid-filters">
        <input
          class="input-search"
          nbInput
          fullWidth
          placeholder="Search user text"
          [(ngModel)]="filter.text"
          (keyup.enter)="refresh()"
        />
        <nb-checkbox [(ngModel)]="filter.exactMatch">Exact text match</nb-checkbox>
      </div>
      <div class="grid-filters">
        <nb-select
          fullWidth
          placeholder="Connector type"
          [(ngModel)]="filter.connectorType"
          (selectedChange)="refresh()"
        >
          <nb-option
            *ngFor="let c of connectorTypes"
            [value]="c"
          >
            {{ c.id }}
          </nb-option>
        </nb-select>
        <nb-select
          fullWidth
          placeholder="Intent"
          [(ngModel)]="filter.intentName"
          (selectedChange)="refresh()"
        >
          <nb-option value="">All</nb-option>
          <nb-option
            *ngFor="let intent of state.currentApplication.intents"
            [value]="intent.name"
          >
            {{ intent.name }}
          </nb-option>
          <nb-option value="unknown">Unknown</nb-option>
        </nb-select>
        <nb-toggle
          class="test"
          [(ngModel)]="filter.displayTests"
          (change)="waitAndRefresh()"
        >
          Display tests
        </nb-toggle>
        <button
          class="search align-self-end"
          nbButton
          status="primary"
          size="small"
          (click)="refresh()"
        >
          <nb-icon icon="search-outline"></nb-icon>
          search
        </button>
      </div>
    </nb-card-body>
  </nb-card>
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-1">
    <span
      *ngIf="loading"
      class="h5 text-muted m-0"
    >
      Loading
    </span>
    <span
      *ngIf="total === 0"
      class="h5 text-muted m-0"
    >
      No dialogs found
    </span>
    <span
      *ngIf="total > 0"
      class="h5 text-muted m-0"
    >
      Dialogs : {{ formattedTotal() }}
    </span>
    <div>
      <button
        *ngIf="filter.dialogId"
        nbButton
        ghost
        shape="round"
        nbTooltip="View all dialogs using this text"
        (click)="viewAllWithThisText()"
      >
        <nb-icon icon="message-square-outline"></nb-icon>
      </button>
      <button
        nbButton
        shape="round"
        ghost
        nbTooltip="Refresh"
        (click)="refresh()"
      >
        <nb-icon icon="refresh-outline"></nb-icon>
      </button>
    </div>
  </div>

  <div
    *ngIf="total !== -1"
    class="mt-2"
    infinite-scroll
    [infiniteScrollDistance]="2"
    [infiniteScrollThrottle]="300"
    (scrolled)="onScroll()"
  >
    <div
      *ngFor="let dialog of data"
      class="mb-2"
    >
      <tock-display-dialog [dialog]="dialog">
        <div *ngIf="dialog.actions.length === 0">No dialog</div>
      </tock-display-dialog>
    </div>
  </div>
</div>
