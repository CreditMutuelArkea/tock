<!--
  ~ Copyright (C) 2017/2021 e-voyageurs technologies
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<nb-accordion
  class="mt-3 mb-2 shadow-none"
  [nbSpinner]="loading"
>
  <nb-accordion-item #accordion>
    <nb-accordion-item-header class="gap-1">
      <span class="h4 m-0">Bot Flow</span>
      <span
        *ngIf="statsMode"
        class="statsMode-badge statsMode-true"
        nbTooltip="Dynamic mode (user flow)"
      >
        Dynamic
      </span>
      <span
        *ngIf="!statsMode"
        class="statsMode-badge statsMode-false"
        nbTooltip="Static mode (available stories)"
      >
        Static
      </span>
    </nb-accordion-item-header>
    <nb-accordion-item-body>
      <div>
        <p class="h5">Mode</p>
        <div class="d-flex flex-wrap gap-1">
          <div class="d-flex align-items-center">
            <span nbTooltip="Show available stories (static mode)"> Available stories </span>
            <nb-toggle
              class="mode-selection"
              [(ngModel)]="statsMode"
              (checkedChange)="changeMode()"
            ></nb-toggle>
            <span nbTooltip="Show effective user trafic (dynamic mode)"> User flow on </span>
          </div>
          <tock-date-range-calendar
            [disabled]="!statsMode"
            [rangeInDays]="7"
            (datesChanged)="datesChanged($event)"
          ></tock-date-range-calendar>
        </div>
      </div>
      <hr class="divider" />
      <div>
        <p class="h5">{{ statsMode ? 'Scope' : 'Scope / Filters' }}</p>
        <div class="d-flex flex-column gap-1">
          <div class="scope-category">
            <p class="mb-2 font-italic">Configurations</p>
            <div class="d-flex flex-wrap align-items-center gap-1">
              <nb-checkbox
                nbTooltip="Allow selecting All Configurations at once (possible performance impact)"
                [(ngModel)]="allowSelectAllConfigs"
                (change)="changeAllowSelectAllConfigs()"
              >
                Allow all
              </nb-checkbox>
              <tock-select-bot
                [allowNoConfigurationSelection]="false"
                noConnectorLabel="All Connectors"
                [allowNoSelection]="allowSelectAllConfigs"
                noConfigurationLabel="All Configurations"
                (selectionChange)="selectedConfigurationChanged($event)"
              >
              </tock-select-bot>
            </div>
          </div>
          <div class="scope-category">
            <p class="mb-2 font-italic">Story</p>
            <div class="scope-story gap-1">
              <nb-select
                placeholder="Story Type"
                fullWidth
                [(ngModel)]="selectedTypeFilter"
                (selectedChange)="update()"
              >
                <nb-select-label>{{ selectedTypeFilter.name }}</nb-select-label>
                <nb-option
                  *ngFor="let typeFilter of typeFilters"
                  [value]="typeFilter"
                  [disabled]="typeFilterCounters.get(typeFilter) < 1"
                >
                  <span nbTooltip="{{ typeFilter.description }}">
                    {{ typeFilter.name }}
                    <span *ngIf="typeFilterCounters.get(typeFilter) > 0"> ({{ typeFilterCounters.get(typeFilter) }})</span></span
                  >
                </nb-option>
              </nb-select>
              <nb-select
                *ngIf="!statsMode"
                fullWidth
                nbTooltip="Story Focus"
                placeholder="Story Focus"
                [(selected)]="selectedStory"
                (selectedChange)="update()"
              >
                <nb-select-label>
                  <span *ngIf="selectedStory">
                    <nb-icon
                      *ngIf="selectedStory.isBuiltIn()"
                      class="story-type"
                      icon="cube"
                    ></nb-icon>
                    <nb-icon
                      *ngIf="selectedStory.isSimpleAnswer()"
                      class="story-type"
                      icon="message-square-outline"
                    ></nb-icon>
                    <nb-icon
                      *ngIf="selectedStory.isScriptAnswer()"
                      class="story-type"
                      icon="code"
                    ></nb-icon>
                    <span class="story-label">{{ selectedStory.name }}</span>
                  </span>
                </nb-select-label>
                <nb-option [value]="undefined">All</nb-option>
                <nb-option
                  *ngFor="let entry of storiesById | keyvalue"
                  [value]="entry.value"
                  [disabled]="!selectedTypeFilter.filter(entry.value)"
                >
                  <nb-icon
                    *ngIf="entry.value.isBuiltIn()"
                    class="story-type"
                    nbTooltip="BuiltIn"
                    icon="cube"
                  ></nb-icon>
                  <nb-icon
                    *ngIf="entry.value.isSimpleAnswer()"
                    class="story-type"
                    nbTooltip="Message"
                    icon="message-square-outline"
                  ></nb-icon>
                  <nb-icon
                    *ngIf="entry.value.isScriptAnswer()"
                    class="story-type"
                    nbTooltip="Script"
                    icon="code"
                  ></nb-icon>
                  {{ entry.value.name }}
                </nb-option>
              </nb-select>
              <nb-select
                *ngIf="statsMode"
                fullWidth
                placeholder="Story Focus"
                [(ngModel)]="selectedStory"
                (selectedChange)="update()"
              >
                <nb-select-label>
                  <span *ngIf="selectedStory">
                    <nb-icon
                      *ngIf="selectedStory.isBuiltIn()"
                      class="story-type"
                      icon="cube"
                    ></nb-icon>
                    <nb-icon
                      *ngIf="selectedStory.isSimpleAnswer()"
                      class="story-type"
                      icon="message-square-outline"
                    ></nb-icon>
                    <nb-icon
                      *ngIf="selectedStory.isScriptAnswer()"
                      class="story-type"
                      icon="code"
                    ></nb-icon>
                    <nb-icon
                      *ngIf="selectedStory.storyType === undefined"
                      class="story-type"
                      icon="question-mark-circle-outline"
                    ></nb-icon>
                    <span class="story-label">{{ selectedStory.storyName }}</span>
                  </span>
                </nb-select-label>
                <nb-option [value]="undefined">All</nb-option>
                <nb-option
                  *ngFor="let entry of nodesById | keyvalue"
                  [value]="entry.value"
                  [disabled]="!selectedTypeFilter.filter(entry.value)"
                >
                  <nb-icon
                    *ngIf="entry.value.isBuiltIn()"
                    class="story-type"
                    nbTooltip="BuiltIn"
                    icon="cube"
                  ></nb-icon>
                  <nb-icon
                    *ngIf="entry.value.isSimpleAnswer()"
                    class="story-type"
                    nbTooltip="Message"
                    icon="message-square-outline"
                  ></nb-icon>
                  <nb-icon
                    *ngIf="entry.value.isScriptAnswer()"
                    class="story-type"
                    nbTooltip="Script"
                    icon="code"
                  ></nb-icon>
                  <nb-icon
                    *ngIf="entry.value.storyType === undefined"
                    class="story-type"
                    nbTooltip="Unknown Type"
                    icon="question-mark-circle-outline"
                  ></nb-icon>
                  {{ entry.value.storyName }}
                </nb-option>
              </nb-select>
              <nb-select
                *ngIf="selectedStory"
                placeholder="Direction"
                fullWidth
                [(ngModel)]="direction"
                (selectedChange)="update()"
              >
                <nb-option [value]="undefined">Both</nb-option>
                <nb-option [value]="-1">Outcoming</nb-option>
                <nb-option [value]="1">Incoming</nb-option>
              </nb-select>
            </div>
          </div>
          <div class="scope-category">
            <p class="mb-2 font-italic">Additional filters</p>
            <div
              *ngIf="statsMode"
              class="d-flex flex-wrap gap-2"
            >
              <nb-checkbox
                [(ngModel)]="entity"
                (change)="update()"
                nbTooltip="View more Nodes by Entity values"
              >
                Entity
              </nb-checkbox>
              <nb-checkbox
                [(ngModel)]="step"
                (change)="update()"
                nbTooltip="View more Nodes by Step"
              >
                Step
              </nb-checkbox>
              <nb-checkbox
                [(ngModel)]="intent"
                (change)="update()"
                nbTooltip="View more Nodes by Intent"
              >
                Intent
              </nb-checkbox>
            </div>
            <div *ngIf="!statsMode">
              <nb-checkbox
                [(ngModel)]="displayDisabled"
                (change)="update()"
                nbTooltip="Include Stories Disabled by Rules"
              >
                Disabled
              </nb-checkbox>
            </div>
          </div>
        </div>
      </div>
      <hr
        *ngIf="statsMode"
        class="divider"
      />
      <div *ngIf="statsMode">
        <p class="h5">Filters</p>
        <div class="d-flex flex-wrap align-items-center gap-1">
          <div class="d-flex flex-column flex-grow-1">
            <span
              class="mb-1"
              nbTooltip="Filter by Minimum Traffic through Node"
            >
              Min. Node Traffic
            </span>
            <input
              type="range"
              class="form-control-range"
              min="0"
              [max]="maxNodeCount"
              step="1"
              [(ngModel)]="minimalNodeCount"
              (change)="updateCount()"
            />
            <small class="align-self-end">{{ minimalNodeCount }} / {{ maxNodeCount }}</small>
          </div>
          <div class="d-flex flex-column flex-grow-1">
            <span
              class="mb-1"
              nbTooltip="Filter by Minimum Percentage of Transitions"
            >
              Min. Transition %:
            </span>
            <input
              type="range"
              class="form-control-range"
              min="0"
              max="100"
              step="1"
              [(ngModel)]="minimalTransitionPercentage"
              (change)="updateCount()"
            />
            <small class="align-self-end">{{ minimalTransitionPercentage }} / 100</small>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <nb-checkbox
              [(ngModel)]="displayTests"
              (change)="reload()"
              nbTooltip="Include Test Flow"
            >
              Tests
            </nb-checkbox>
            <nb-checkbox
              [(ngModel)]="mergeOldStories"
              (change)="update()"
              nbTooltip="Merge Old Stats to Latest Stories when possible"
            >
              Merge to Latest Stories
            </nb-checkbox>
          </div>
        </div>
      </div>
      <hr class="divider" />
      <div>
        <p class="h5">Presentation</p>
        <div class="d-flex flex-column gap-1 mb-2">
          <nb-select
            placeholder="Layout"
            fullWidth
            [(ngModel)]="selectedLayout"
            (selectedChange)="changeLayout()"
          >
            <nb-option
              *ngFor="let l of layouts"
              [value]="l.name"
              >{{ l.name }}</nb-option
            >
          </nb-select>
          <div class="d-flex align-items-center flex-wrap gap-2">
            <nb-checkbox
              *ngIf="statsMode"
              [(ngModel)]="recursive"
              (change)="update()"
              nbTooltip="Display Recursive Transitions from each Node to itself"
            >
              Recursive Transitions
            </nb-checkbox>
            <nb-checkbox
              [(ngModel)]="displayNodeType"
              (change)="updateCount()"
              nbTooltip="Display Story Type icon on each Node"
            >
              Story Types
            </nb-checkbox>
            <nb-checkbox
              *ngIf="statsMode"
              [(ngModel)]="displayNodeCount"
              (change)="updateCount()"
              nbTooltip="Display Story trafic on each Node"
            >
              Story Counts
            </nb-checkbox>
            <nb-checkbox
              *ngIf="!statsMode"
              [(ngModel)]="intent"
              (change)="updateCount()"
              nbTooltip="Display Story Main Intent on each Node"
            >
              Main Intents
            </nb-checkbox>
            <nb-checkbox
              [(ngModel)]="displayDebug"
              nbTooltip="Display Debug stats"
            >
              Debug
            </nb-checkbox>
          </div>
        </div>
        <div
          *ngIf="displayDebug"
          class="d-flex flex-wrap gap-1 font-italic"
        >
          <span *ngIf="nodesById || storiesById">Total Stories: {{ statsMode ? nodesById.size : storiesById.size }}</span>
          <span *ngIf="nodesById || storiesById">Filtered Stories: {{ allNodes.length }}</span>
          <span *ngIf="allTransitions">Filtered Transitions: {{ allTransitions.size }}</span>
        </div>
      </div>
    </nb-accordion-item-body>
  </nb-accordion-item>
</nb-accordion>

<nb-card
  *ngIf="selectedLayout !== 'Sankey'"
  size="giant"
>
  <nb-card-header class="d-flex justify-content-end">
    <tock-story
      *ngIf="graphData && selectedNode"
      [storyNode]="selectedNode"
      [botId]="state.currentApplication.name"
      [displayCount]="statsMode"
    ></tock-story>

    <span *ngIf="graphData && selectedEdge">
      Count of selected edges: <b>{{ selectedEdge.count }}</b>
    </span>

    <button
      *ngIf="graphData && !selectedNode && !selectedEdge"
      nbButton
      status="primary"
      routerLink="/build/story-create"
    >
      Add a New Story
    </button>
  </nb-card-header>
  <nb-card-body
    *ngIf="graphData"
    class="p-0"
  >
    <tock-cytoscape
      [elements]="graphData"
      [layout]="layout"
      (selectedNode)="nodeChange($event)"
      (selectedEdge)="edgeChange($event)"
    ></tock-cytoscape>
  </nb-card-body>
</nb-card>
<nb-card
  *ngIf="selectedLayout === 'Sankey'"
  size="giant"
>
  <nb-card-body>
    <google-chart
      *ngIf="flowData !== null"
      class="w-100 h-100"
      type="Sankey"
      [data]="flowData.data"
      [columns]="flowData.columnNames"
      [options]="flowData.options"
      [dynamicResize]="true"
    >
    </google-chart>
  </nb-card-body>
</nb-card>
