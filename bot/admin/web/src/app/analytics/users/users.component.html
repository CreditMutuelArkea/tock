<!--
  ~ Copyright (C) 2017/2021 e-voyageurs technologies
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<div class="users mt-3">
  <nb-card class="aside">
    <nb-card-header
      class="d-flex justify-content-between gap-1"
      [nbSpinner]="loading"
    >
      <span *ngIf="total > 0">Users : {{ formattedTotal() }}</span>
      <span *ngIf="total === 0">No users</span>
      <button
        nbButton
        ghost="true"
        shape="round"
        nbTooltip="Refresh"
        (click)="reload()"
      >
        <nb-icon icon="refresh-outline"></nb-icon>
      </button>
    </nb-card-header>
    <nb-list
      nbInfiniteList
      [threshold]="500"
      (bottomThreshold)="load()"
    >
      <nb-list-item
        *ngFor="let user of data"
        class="chat-item"
      >
        <nb-card
          accent="{{ user.playerId === selectedUser?.playerId ? 'info' : '' }}"
          class="chat-card pointer m-0 w-100"
        >
          <nb-card-header (click)="loadDialog(user)">
            <img
              *ngIf="getConnector(user.applicationIds[0])"
              src="{{ getConnector(user.applicationIds[0]).iconUrl() }}"
              class="connector"
              [nbTooltip]="getConnector(user.applicationIds[0]).label()"
            />
            <nb-user
              size="large"
              name="{{ user.userPreferences.firstName ? user.userPreferences.firstName : 'Anonymous' }} {{ user.userPreferences.lastName }}"
              title="{{ user.lastUpdateDate | amDateFormat: 'DD MMM YYYY HH:mm' }}"
              picture="{{ getUserPicture(user) }}"
            >
            </nb-user>
          </nb-card-header>
          <nb-card-body class="p-0">
            <nb-accordion>
              <nb-accordion-item
                [collapsed]="isCollapsed"
                (click)="toggle()"
              >
                <nb-accordion-item-header>
                  <div class="d-flex flex-column text-muted">
                    <span *ngIf="user.botConfiguration"
                      >[{{ user.botConfiguration.name }} - {{ user.botConfiguration.connectorType.id }}]</span
                    >
                    <span *ngIf="user.userPreferences.locale">({{ user.userPreferences.locale }})</span>
                    <span *ngIf="user.lastActionText"> {{ user.lastActionText }}</span>
                    <span
                      *ngIf="!user.botConfiguration && !user.userPreferences.locale && !user.lastActionText"
                      class="font-italic"
                    >
                      Not informed
                    </span>
                  </div>
                </nb-accordion-item-header>
                <nb-accordion-item-body>
                  <nb-tag-list *ngIf="user.userState.flags.length !== 0">
                    <nb-tag
                      *ngFor="let f of user.userState.flags"
                      class="pointer"
                      [text]="f"
                      [appearance]="containsFlag(f) ? 'filled' : 'outline'"
                      status="primary"
                      nbTooltip="Filter by flag {{ f }}"
                      (click)="toggleFlag(f)"
                    ></nb-tag>
                  </nb-tag-list>
                </nb-accordion-item-body>
              </nb-accordion-item>
            </nb-accordion>
          </nb-card-body>
        </nb-card>
      </nb-list-item>
    </nb-list>
  </nb-card>
  <nb-card
    class="main"
    [nbSpinner]="loadingDialog"
  >
    <nb-card-header class="grid-filters">
      <input
        nbInput
        placeholder="Modified after"
        fullWidth
        [nbDatepicker]="from_date"
        [(ngModel)]="filter.from"
      />
      <input
        nbInput
        placeholder="Modified before"
        fullWidth
        [nbDatepicker]="to_date"
        [(ngModel)]="filter.to"
      />
      <nb-toggle
        [(ngModel)]="filter.displayTests"
        (change)="waitAndRefresh()"
      >
        Display tests
      </nb-toggle>
    </nb-card-header>
    <nb-card-body>
      <nb-alert
        *ngIf="!selectedUser"
        class="d-flex flex-row align-items-center gap-1 m-0"
        outline="info"
      >
        <nb-icon
          icon="info-outline"
          status="info"
        ></nb-icon>
        Select a user to display dialogs
      </nb-alert>
      <tock-display-dialog
        *ngIf="selectedUser && selectedUser.displayDialogs && selectedUser.userDialog"
        [dialog]="selectedUser.userDialog"
        [userPicture]="getUserPicture(selectedUser)"
      >
        <div *ngIf="selectedUser.userDialog.actions.length === 0">No dialog</div>
        <div *ngIf="selectedUser.userDialog.actions.length !== 0">
          <div
            *ngIf="selectedUser.testPlans && selectedUser.testPlans.length !== 0"
            class="d-flex gap-1 mb-4"
          >
            <nb-select
              [(ngModel)]="selectedPlan"
              placeholder="Select a Test Plan"
              fullWidth
            >
              <nb-option
                *ngFor="let plan of selectedUser.testPlans"
                [value]="plan._id"
                >{{ plan.name }}
              </nb-option>
            </nb-select>
            <button
              nbButton
              status="primary"
              nbTooltip="Add dialog to Test Plan"
              (click)="addDialogToTestPlan(selectedPlan, selectedUser.userDialog)"
            >
              <nb-icon icon="plus-outline"></nb-icon>
            </button>
          </div>
        </div>
      </tock-display-dialog>
    </nb-card-body>
  </nb-card>
</div>

<nb-datepicker
  (dateChange)="changeAfter()"
  #from_date
></nb-datepicker>
<nb-datepicker
  (dateChange)="changeBefore()"
  #to_date
></nb-datepicker>
