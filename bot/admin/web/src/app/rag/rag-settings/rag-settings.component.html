<form [formGroup]="form">
  <nb-card class="mt-3">
    <nb-card-header class="d-flex flex-wrap align-items-center justify-content-between">
      Retrieval Augmented Generation settings

      <nb-toggle
        class="m-2"
        nbTooltip="Activate/deactivate Rag"
      >
        Activate/deactivate Rag
      </nb-toggle>
    </nb-card-header>

    <nb-card-body>
      <tock-form-control
        label="LLM Engine"
        name="engine"
        [controls]="engine"
        [required]="true"
        [showError]="isSubmitted"
      >
        <nb-radio-group
          formControlName="engine"
          class="d-flex"
        >
          <nb-radio
            *ngFor="let engine of LlmEngines"
            [value]="engine.key"
          >
            {{ engine.label }}
          </nb-radio>
        </nb-radio-group>
      </tock-form-control>

      <div
        *ngIf="engine.value"
        class="mt-2"
      >
        <div class="font-weight-bold mb-3">{{ currentEngineLabel }} parameters</div>

        <div class="engine-params">
          <div *ngFor="let param of currentEngineParams">
            <tock-form-control
              [label]="param.label"
              [name]="param.key"
              [controls]="getFormControlByName(param.key)"
              [required]="true"
              [boldLabel]="false"
              [showError]="isSubmitted"
            >
              <ng-container *ngIf="param.type === 'string'">
                <input
                  nbInput
                  fullWidth
                  [formControlName]="param.key"
                />
              </ng-container>

              <ng-container *ngIf="param.type === 'list'">
                <nb-select
                  fullWidth
                  [formControlName]="param.key"
                >
                  <nb-option
                    *ngFor="let source of param.source"
                    [value]="source"
                  >
                    {{ source }}
                  </nb-option>
                </nb-select>
              </ng-container>
            </tock-form-control>
          </div>
        </div>
      </div>

      <tock-form-control
        label="Temperature"
        name="temperature"
        [controls]="temperature"
        [required]="true"
        [showError]="isSubmitted"
      >
        <tock-slider
          min="0"
          max="1"
          step="0.05"
          formControlName="temperature"
        ></tock-slider>
      </tock-form-control>

      <tock-form-control
        label="Embedding Engine"
        name="embeddingEngine"
        [controls]="embeddingEngine"
        [required]="true"
        [showError]="isSubmitted"
      >
        <nb-select
          formControlName="embeddingEngine"
          class="d-flex"
        >
          <nb-option
            *ngFor="let embedding of EmbeddingEngines"
            [value]="embedding"
          >
            {{ embedding }}
          </nb-option>
        </nb-select>
      </tock-form-control>

      <tock-form-control
        label="Prompt"
        name="prompt"
        [controls]="prompt"
        [required]="true"
        [showError]="isSubmitted"
        [hasMargin]="false"
      >
        <textarea
          formControlName="prompt"
          nbInput
          fullWidth
          rows="8"
          placeholder="Enter prompt string"
        ></textarea>
      </tock-form-control>

      <div class="d-flex justify-content-between mt-1 mb-3">
        <button
          nbButton
          size="tiny"
          (click)="restoreDefaultPrompt()"
        >
          Restore default prompt
        </button>

        <div class="d-flex">
          <small> No answer story redirection </small>

          <nb-select
            formControlName="noAnswerRedirection"
            size="tiny"
            class="ml-3"
          >
            <nb-option
              class="text-muted"
              value=""
            >
              none
            </nb-option>

            <nb-option
              *ngFor="let story of availableStories"
              [value]="story.storyId"
            >
              {{ story.name }}
            </nb-option>
          </nb-select>
        </div>
      </div>

      <button
        nbButton
        (click)="submit()"
      >
        submit
      </button>
    </nb-card-body>
  </nb-card>
</form>
