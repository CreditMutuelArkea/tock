<div
  class="arrow-wrapper"
  *ngIf="item.id > 0"
>
  <div
    class="arrow-top-left"
    *ngIf="shouldShowArrowTop('left')"
  ></div>
  <div
    class="arrow-top-right"
    *ngIf="shouldShowArrowTop('right')"
  ></div>
  <div class="arrow"></div>
</div>

<div [dndDraggable]="draggable.data">
  <div
    class="item-card"
    #itemCard
    [ngClass]="getItemCardCssClass()"
    dndDropzone
    (dndDrop)="onDrop($event)"
    dndDragoverClass="dragHover"
    (click)="selectItem()"
    appMouseWheelListner
    (onMouseWheel)="mouseWheel($event)"
  >
    <div
      class="from-icon client"
      (click)="switchItemType(SCENARIO_ITEM_FROM_CLIENT)"
    >
      <img
        src="assets/images/scenario-client.svg"
        class="cursor-move"
        dndHandle
        *ngIf="item.from == SCENARIO_ITEM_FROM_CLIENT"
      />
      <img
        src="assets/images/scenario-client.svg"
        *ngIf="item.from != SCENARIO_ITEM_FROM_CLIENT && mode == SCENARIO_MODE_WRITING"
      />
      <div
        class="duplication-count"
        dndHandle
        *ngIf="item.from == SCENARIO_ITEM_FROM_CLIENT && item.parentIds?.length > 1"
      >
        {{ item.parentIds?.length }}
      </div>
    </div>
    <div
      class="from-icon bot"
      (click)="switchItemType(SCENARIO_ITEM_FROM_BOT)"
      *ngIf="item.parentIds?.length && !item.intentDefinition"
    >
      <img
        src="assets/images/scenario-bot.svg"
        class="cursor-move"
        dndHandle
        *ngIf="item.from == SCENARIO_ITEM_FROM_BOT"
      />
      <img
        src="assets/images/scenario-bot.svg"
        *ngIf="item.from != SCENARIO_ITEM_FROM_BOT && mode == SCENARIO_MODE_WRITING"
      />
      <div
        class="duplication-count"
        dndHandle
        *ngIf="item.from == SCENARIO_ITEM_FROM_BOT && item.parentIds?.length > 1"
      >
        {{ item.parentIds?.length }}
      </div>
    </div>
    <div
      class="from-icon api"
      (click)="switchItemType(SCENARIO_ITEM_FROM_API)"
      *ngIf="item.parentIds?.length && !item.intentDefinition"
    >
      <img
        src="assets/images/scenario-verification.svg"
        class="cursor-move"
        dndHandle
        *ngIf="item.from == SCENARIO_ITEM_FROM_API"
      />
      <img
        src="assets/images/scenario-verification.svg"
        *ngIf="item.from != SCENARIO_ITEM_FROM_API && mode == SCENARIO_MODE_WRITING"
      />
      <div
        class="duplication-count"
        dndHandle
        *ngIf="item.from == SCENARIO_ITEM_FROM_API && item.parentIds?.length > 1"
      >
        {{ item.parentIds?.length }}
      </div>
    </div>

    <div class="item-infos d-flex align-items-start flex-column">
      <div class="align-self-stretch">
        <div
          class="mb-2"
          *ngIf="isAnApiAnswer()"
        >
          <nb-select
            [(ngModel)]="item.apiResponse"
            (selectedChange)="onApiAnswerSelected()"
            fullWidth
            [status]="getApiResponseSelectStatus()"
            size="tiny"
            filled
            placeholder="Select api response"
            [title]="item.apiResponse"
          >
            <nb-option
              *ngFor="let responseVal of getApiAnswers()"
              [value]="responseVal"
              >{{ responseVal }}</nb-option
            >
          </nb-select>
        </div>

        <textarea
          *ngIf="!itemHasDefinition()"
          #itemTextarea
          fullWidth
          rows="4"
          placeholder="Question"
          [(ngModel)]="item.text"
        ></textarea>

        <strong *ngIf="itemHasDefinition()">{{ item.text }}</strong>

        <div
          *ngIf="item.from == SCENARIO_ITEM_FROM_CLIENT && itemHasDefinition()"
          class="sentences mb-2"
          [nbSpinner]="utterancesLoading"
        >
          <div class="questions">
            <ul>
              <li
                *ngFor="let sentence of item.intentDefinition.sentences"
                class="ellipsis"
                [title]="sentence"
              >
                {{ sentence }}
              </li>
            </ul>
            <ul>
              <li
                *ngFor="let sentence of item.intentDefinition._sentences"
                class="ellipsis text-muted"
                [title]="sentence"
              >
                {{ sentence }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="mt-auto align-self-stretch">
        <div class="d-flex justify-content-between mt-1">
          <div
            *ngIf="
              mode == SCENARIO_MODE_WRITING &&
              item.from == SCENARIO_ITEM_FROM_BOT &&
              itemHasNoChildren()
            "
          >
            <nb-checkbox
              (checkedChange)="toggleFinal($event)"
              [checked]="item.final"
              nbTooltip="Define this item as ending the conversation"
              >End of chat</nb-checkbox
            >
          </div>
          <button
            nbButton
            size="tiny"
            status="primary"
            *ngIf="!itemHasNoChildren()"
            (click)="test()"
            nbTooltip="Test the conversation from this point"
          >
            Test
          </button>
          <button
            nbButton
            size="tiny"
            status="warning"
            *ngIf="mode == SCENARIO_MODE_WRITING && item.id > 0 && itemHasNoChildren()"
            (click)="delete()"
            nbTooltip="Remove this item"
          >
            Delete
          </button>
          <button
            nbButton
            size="tiny"
            status="info"
            *ngIf="mode == SCENARIO_MODE_WRITING && itemCanHaveAnswer()"
            (click)="answering()"
            nbTooltip="Add an answer to this item"
          >
            Add answer
          </button>

          <button
            nbButton
            size="tiny"
            status="info"
            *ngIf="
              mode == SCENARIO_MODE_PRODUCTION &&
              item.from == SCENARIO_ITEM_FROM_CLIENT &&
              item.text?.length
            "
            (click)="manageIntent()"
            nbTooltip="Intent infos and edition"
          >
            Manage intent
          </button>

          <button
            nbButton
            size="tiny"
            status="info"
            *ngIf="
              mode == SCENARIO_MODE_PRODUCTION &&
              item.from == SCENARIO_ITEM_FROM_API &&
              item.text?.length
            "
            (click)="manageApi()"
            nbTooltip="Api call infos and edition"
          >
            Manage api call
          </button>
        </div>
      </div>
    </div>
  </div>

  <div
    class="arrow-wrapper"
    *ngIf="itemHasSeveralChildren()"
  >
    <div class="arrow"></div>
  </div>

  <div class="card-row">
    <ng-container *ngFor="let childItem of getChildItems()">
      <div class="card-col">
        <scenario-designer-entry
          [itemId]="childItem.id"
          [parentId]="item.id"
          [dataList]="dataList"
          [selectedItem]="selectedItem"
          [mode]="mode"
        ></scenario-designer-entry>
      </div>
    </ng-container>
  </div>
</div>
