<nb-card id="modal-wrapper">
  <nb-card-header class="d-flex justify-content-between align-items-start gap-1">
    Action definition
    <button
      nbButton
      ghost
      shape="round"
      nbTooltip="Cancel"
      (click)="cancel()"
    >
      <nb-icon icon="close-outline"></nb-icon>
    </button>
  </nb-card-header>

  <nb-card-body>
    <form
      [formGroup]="form"
      (submit)="save()"
    >
      <tock-form-control
        label="Name"
        name="name"
        required="true"
        [controls]="name"
        [showError]="isSubmitted"
      >
        <input
          *ngIf="!isReadonly"
          nbInput
          autofocusElement
          formControlName="name"
          fullWidth
          id="name"
          type="text"
          placeholder="Enter endpoint name"
          (blur)="formatActionName()"
          data-testid="name"
        />
        <span
          *ngIf="isReadonly"
          class="text-mitigated"
        >
          {{ name.value }}
        </span>
      </tock-form-control>

      <div class="position-relative">
        <div
          *ngIf="!isReadonly"
          class="position-absolute"
          style="left: 50%"
        >
          <nb-icon
            icon="arrowhead-up-outline"
            status="basic"
            nbTooltip="Use description as action name"
            class="pointer"
            (click)="copyDescToName()"
          ></nb-icon>
        </div>

        <tock-form-control
          label="Description"
          name="description"
          [controls]="description"
          [showError]="isSubmitted"
        >
          <textarea
            *ngIf="!isReadonly"
            nbInput
            formControlName="description"
            fullWidth
            id="description"
            placeholder="Enter description"
            rows="4"
          ></textarea>
          <span
            *ngIf="isReadonly"
            class="text-mitigated"
          >
            {{ description.value }}
          </span>
        </tock-form-control>
      </div>

      <div>
        <tock-form-control
          *ngIf="!isReadonly"
          label="Input contexts"
          name="inputContexts"
          [controls]="inputContextsAddError"
          [showError]="true"
        >
          <div class="d-flex">
            <div class="w-100">
              <input
                #inputContextsInput
                nbInput
                fullWidth
                id="inputContexts"
                type="text"
                placeholder="Add an input context and press enter"
                (keyup)="resetContextsAddErrors()"
                (keyup.enter)="addContext('input')"
                autocomplete="off"
                [nbAutocomplete]="inputContextsAutocomplete"
                (focus)="updateContextsAutocompleteValues()"
                (keyup)="updateContextsAutocompleteValues($event)"
              />
              <nb-autocomplete #inputContextsAutocomplete>
                <nb-option
                  *ngFor="let option of contextsAutocompleteValues | async"
                  [value]="option"
                >
                  {{ option }}
                </nb-option>
              </nb-autocomplete>
            </div>

            <button
              type="button"
              nbButton
              ghost
              size="small"
              class="ml-1"
              [disabled]="!inputContextsInput.value.length"
              (click)="addContext('input')"
            >
              Add
            </button>
          </div>
        </tock-form-control>

        <label *ngIf="isReadonly">Input contexts</label>

        <nb-list class="contexts-list">
          <nb-list-item
            *ngFor="let inputContext of inputContextNames.value"
            class="p-2 d-flex justify-content-between"
          >
            <div class="d-flex flex-wrap justify-content-between w-100 mr-2">
              <div class="ellipsis font-weight-bold">
                {{ inputContext }}
              </div>

              <ng-container *ngFor="let context of getContextByName(inputContext)">
                <span
                  *ngIf="context?.entityType"
                  nbTooltip="Entity associated with the context"
                  class="entity"
                  [style.background]="getContextEntityColor(context)"
                  [style.color]="getContextEntityContrast(context)"
                >
                  {{ qualifiedName(state.user, context.entityType, context.entityRole) }}
                </span>
              </ng-container>
            </div>

            <nb-icon
              *ngIf="!isReadonly"
              icon="trash-2-outline"
              status="danger"
              (click)="removeContext('input', inputContext)"
              class="min-width-1em ml-2 pointer"
              nbTooltip="Remove this context from inputs"
            ></nb-icon>
          </nb-list-item>
        </nb-list>
      </div>

      <div>
        <nb-icon
          *ngIf="!isReadonly"
          icon="arrowhead-right-outline"
          status="basic"
          nbTooltip="Use description as answer"
          class="pointer"
          (click)="copyDescToAnswer()"
        ></nb-icon>
      </div>

      <tock-form-control
        label="Api handler"
        name="handler"
        [controls]="handler"
        [showError]="isSubmitted"
      >
        <input
          *ngIf="!isReadonly"
          nbInput
          formControlName="handler"
          fullWidth
          id="handler"
          type="text"
          placeholder="Enter handler class name"
          autocomplete="off"
          [nbAutocomplete]="handlersAutocomplete"
          (focus)="updateHandlersAutocompleteValues()"
          (keyup)="updateHandlersAutocompleteValues($event)"
        />
        <nb-autocomplete #handlersAutocomplete>
          <nb-option
            *ngFor="let option of handlersAutocompleteValues | async"
            [value]="option"
          >
            {{ option }}
          </nb-option>
        </nb-autocomplete>
        <span
          *ngIf="isReadonly"
          class="text-mitigated"
        >
          {{ handler.value }}
        </span>
      </tock-form-control>

      <tock-form-control
        label="Answer"
        name="answer"
        [controls]="answer"
        [showError]="isSubmitted"
      >
        <textarea
          *ngIf="!isReadonly"
          nbInput
          formControlName="answer"
          fullWidth
          id="answer"
          placeholder="Enter answer"
          rows="4"
        ></textarea>
        <span
          *ngIf="isReadonly"
          class="text-mitigated"
        >
          {{ answer.value }}
        </span>
      </tock-form-control>

      <div>
        <tock-form-control
          *ngIf="!isReadonly"
          label="Output contexts"
          name="outputContexts"
          [controls]="outputContextsAddError"
          [showError]="true"
        >
          <div class="d-flex">
            <div class="w-100">
              <input
                #outputContextsInput
                nbInput
                fullWidth
                id="outputContexts"
                type="text"
                placeholder="Add an output context and press enter"
                (keyup)="resetContextsAddErrors()"
                (keyup.enter)="addContext('output')"
                autocomplete="off"
                [nbAutocomplete]="outputContextsAutocomplete"
                (focus)="updateContextsAutocompleteValues()"
                (keyup)="updateContextsAutocompleteValues($event)"
              />
              <nb-autocomplete #outputContextsAutocomplete>
                <nb-option
                  *ngFor="let option of contextsAutocompleteValues | async"
                  [value]="option"
                >
                  {{ option }}
                </nb-option>
              </nb-autocomplete>
            </div>

            <button
              type="button"
              nbButton
              ghost
              size="small"
              class="ml-1"
              [disabled]="!outputContextsInput.value.length"
              (click)="addContext('output')"
            >
              Add
            </button>
          </div>
        </tock-form-control>

        <label *ngIf="isReadonly">Output contexts</label>

        <nb-list class="contexts-list">
          <nb-list-item
            *ngFor="let outputContext of outputContextNames.value"
            class="p-2 d-flex justify-content-between"
          >
            <div class="ellipsis font-weight-bold">
              {{ outputContext }}
            </div>

            <ng-container *ngFor="let context of getContextByName(outputContext)">
              <span
                *ngIf="context?.entityType"
                nbTooltip="Entity associated with the context"
                class="entity"
                [style.background]="getContextEntityColor(context)"
                [style.color]="getContextEntityContrast(context)"
              >
                {{ qualifiedName(state.user, context.entityType, context.entityRole) }}
              </span>
            </ng-container>

            <nb-icon
              *ngIf="!isReadonly"
              icon="trash-2-outline"
              status="danger"
              class="min-width-1em ml-2 pointer"
              nbTooltip="Remove this context from outputs"
              (click)="removeContext('output', outputContext)"
            ></nb-icon>
          </nb-list-item>
        </nb-list>
      </div>
    </form>
  </nb-card-body>

  <nb-card-footer class="card-footer-actions">
    <button
      nbButton
      ghost
      size="small"
      (click)="cancel()"
    >
      <span *ngIf="!isReadonly">Cancel</span>
      <span *ngIf="isReadonly">Close</span>
    </button>

    <button
      *ngIf="item.actionDefinition && !isReadonly"
      nbButton
      size="small"
      status="danger"
      (click)="removeActionDefinition()"
    >
      Delete action definition
    </button>

    <button
      *ngIf="!isReadonly"
      nbButton
      size="small"
      status="primary"
      (click)="save()"
      [disabled]="!canSave"
    >
      Save
    </button>
  </nb-card-footer>
</nb-card>
