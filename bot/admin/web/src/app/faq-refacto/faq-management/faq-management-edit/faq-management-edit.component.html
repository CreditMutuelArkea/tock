<nb-card
  class="side-panel"
  [nbSpinner]="loading"
>
  <nb-card-header>
    <div class="d-flex justify-content-between align-items-start">
      <h4>{{ faq?.id ? 'Edit "' + faq.title + '"' : 'New faq' }}</h4>
      <button
        type="button"
        nbButton
        ghost
        shape="round"
        nbTooltip="Close"
        (click)="close()"
      >
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <form [formGroup]="form">
      <nb-tabset
        fullWidth
        (changeTab)="setCurrentTab($event)"
      >
        <nb-tab
          tabTitle="info"
          badgePosition="top right"
          badgeStatus="danger"
          [badgeDot]="isSubmitted && (title.errors || description.errors)"
          [active]="currentTab == 'info'"
        >
        </nb-tab>
        <nb-tab
          tabTitle="question"
          badgePosition="top right"
          badgeStatus="danger"
          [badgeDot]="isSubmitted && utterances.errors"
          [active]="currentTab == 'question'"
        >
        </nb-tab>
        <nb-tab
          tabTitle="answer"
          badgePosition="top right"
          badgeStatus="danger"
          [badgeDot]="isSubmitted && answer.errors"
          [active]="currentTab == 'answer'"
        >
        </nb-tab>
      </nb-tabset>

      <div *ngIf="currentTab == 'info'">
        <div class="d-flex flex-column mb-2">
          <label
            for="name"
            class="required"
            ><abbr title="Required">*</abbr>Name</label
          >
          <input
            #nameInput
            nbInput
            formControlName="title"
            id="name"
            fullWidth
            type="text"
            placeholder="Enter faq title"
          />
          <tock-error-helper
            *ngIf="isSubmitted"
            class="mt-1"
            [field]="title"
          ></tock-error-helper>
        </div>
        <div class="d-flex flex-column mb-2">
          <label for="description">Description</label>
          <textarea
            nbInput
            formControlName="description"
            fullWidth
            id="description"
            type="text"
            rows="8"
            placeholder="Enter description"
          ></textarea>
          <small [ngClass]="getControlLengthIndicatorClass('description')"
            >{{ form.controls.description.value.length }} characters out of
            {{ controlsMaxLength.description }} max</small
          >
          <tock-error-helper
            *ngIf="isSubmitted"
            class="mt-1"
            [field]="description"
          ></tock-error-helper>
        </div>
        <div class="d-flex flex-column mb-2">
          <label for="tags">Tags</label>
          <nb-tag-list
            tock-delay
            (tagRemove)="onTagRemove($event)"
          >
            <nb-tag
              *ngFor="let tag of tags.value"
              removable
              [text]="tag"
            ></nb-tag>
            <input
              nbTagInput
              #tagInput
              fullWidth
              id="tags"
              type="text"
              placeholder="Type tag and press enter"
              (tagAdd)="onTagAdd($event)"
              (keydown.enter)="eventPreventDefault($event)"
              autocomplete="off"
              [nbAutocomplete]="tagsAutocomplete"
            />
            <nb-autocomplete
              #tagsAutocomplete
              (selectedChange)="tagSelected($event)"
            >
              <nb-option
                *ngFor="let option of tagsAutocompleteValues | async"
                [value]="option"
              >
                {{ option }}
              </nb-option>
            </nb-autocomplete>
          </nb-tag-list>
        </div>
      </div>

      <div *ngIf="currentTab == 'question'">
        <div class="mb-2">
          <div>
            <label
              for="question"
              class="required"
              ><abbr title="Required">*</abbr>Question</label
            >
            <div class="d-flex">
              <input
                #addUtteranceInput
                nbInput
                fullWidth
                id="question"
                type="text"
                placeholder="Add a new formulation and press enter"
                [disabled]="lookingForSameUterranceInOtherInent"
                (keyup)="resetAlerts()"
                (keyup.enter)="addUtterance()"
              />
              <button
                type="button"
                nbButton
                nbTooltip="Add"
                ghost
                size="small"
                [disabled]="lookingForSameUterranceInOtherInent"
                (click)="addUtterance()"
              >
                Add
              </button>
            </div>
          </div>
          <nb-alert
            status="danger"
            *ngIf="existingUterranceInOtherintent"
            class="closable mt-2"
          >
            <button
              type="button"
              aria-label="Close"
              class="close alert-custom-close"
              (click)="resetAlerts()"
            >
              <span>Ã—</span>
            </button>

            Addition cancelled. This Sentence is already associated with the intent :
            <strong> "{{ existingUterranceInOtherintent }}" </strong>
          </nb-alert>
        </div>

        <tock-error-helper
          *ngIf="isSubmitted"
          class="mt-1"
          [field]="utterances"
        ></tock-error-helper>

        <div
          #utterancesListWrapper
          class="entries-list d-flex flex-column mb-2"
          [nbSpinner]="lookingForSameUterranceInOtherInent"
        >
          <ul>
            <li
              *ngFor="let utterance of utterances.controls"
              class="d-flex justify-content-between align-items-center"
            >
              <div
                class="flex-grow-1"
                *ngIf="!utterance._edit"
              >
                {{ utterance.value }}
              </div>
              <div
                class="flex-grow-1 mr-3"
                *ngIf="utterance._edit"
              >
                <textarea
                  nbInput
                  fullWidth
                  fieldSize="small"
                  [(ngModel)]="utteranceEditionValue"
                  [ngModelOptions]="{ standalone: true }"
                  (keyup.enter)="validateEditUtterance(utterance)"
                ></textarea>
              </div>

              <button
                *ngIf="!utterance._edit"
                type="button"
                nbButton
                nbTooltip="Edit"
                ghost
                shape="round"
                size="small"
                (click)="editUtterance(utterance.value)"
              >
                <nb-icon icon="edit-outline"></nb-icon>
              </button>
              <button
                *ngIf="utterance._edit"
                type="button"
                nbButton
                nbTooltip="Validate changes"
                shape="round"
                size="small"
                status="success"
                (click)="validateEditUtterance(utterance)"
              >
                <nb-icon icon="checkmark-outline"></nb-icon>
              </button>

              <button
                *ngIf="!utterance._edit"
                type="button"
                nbButton
                nbTooltip="Delete"
                ghost
                shape="round"
                size="small"
                status="danger"
                (click)="removeUtterance(utterance.value)"
              >
                <nb-icon icon="trash-2-outline"></nb-icon>
              </button>

              <button
                *ngIf="utterance._edit"
                type="button"
                nbButton
                nbTooltip="Cancel changes"
                ghost
                shape="round"
                size="small"
                (click)="cancelEditUtterance(utterance)"
              >
                <nb-icon icon="close-outline"></nb-icon>
              </button>
            </li>
          </ul>
        </div>
      </div>

      <div *ngIf="currentTab == 'answer'">
        <div class="d-flex flex-column mb-2">
          <label
            for="answer"
            class="required"
            ><abbr title="Required">*</abbr>Answer</label
          >
          <textarea
            #answerInput
            nbInput
            formControlName="answer"
            fullWidth
            id="answer"
            type="text"
            rows="8"
            placeholder="Enter answer"
          ></textarea>
          <small [ngClass]="getControlLengthIndicatorClass('answer')"
            >{{ form.controls.answer.value.length }} characters out of
            {{ controlsMaxLength.answer }} max</small
          >
          <tock-error-helper
            *ngIf="isSubmitted"
            class="mt-1"
            [field]="answer"
          ></tock-error-helper>
        </div>
      </div>
    </form>
  </nb-card-body>

  <nb-card-footer>
    <div class="grid-button">
      <button
        type="button"
        nbButton
        outline
        status="primary"
        size="small"
        (click)="close()"
      >
        Cancel
      </button>
      <button
        type="button"
        nbButton
        status="primary"
        size="small"
        [disabled]="!canSave"
        (click)="save()"
      >
        Save
      </button>
    </div>
  </nb-card-footer>
</nb-card>
